---
title: "System_design"
date: 2020-08-09T20:50:42+08:00
draft: true
---

# 负载均衡算法
- 轮询（Round Robin）法，加权轮询（Weight Round Robin）法
- 随机（Random）法，加权随机（Weight Random）法
- 源地址哈希（Hash）法
    源地址哈希的思想是获取客户端访问的IP地址值，通过哈希函数计算得到一个数值，用该数值对服务器列表的大小进行取模运算，得到的结果便是要访问的服务器的序号。
- 最小连接数（Least Connections）法

# 服务雪崩、降级与熔断
- 服务熔断
熔断这一概念来源于电子工程中的断路器（Circuit Breaker）。在互联网系统中，当下游服务因访问压力过大而响应变慢或失败，上游服务为了保护系统整体的可用性，可以暂时切断对下游服务的调用。这种牺牲局部，保全整体的措施就叫做熔断。

- 服务雪崩
一旦下游服务C因某些原因变得不可用，积压了大量请求，服务B的请求线程也随之阻塞。线程资源逐渐耗尽，使得服务B也变得不可用。紧接着，服务A也变为不可用，整个调用链路被拖垮。像这种调用链路的连锁故障，叫做雪崩。

服务熔断和服务降级就可以视为解决服务雪崩的手段之一。

- 服务降级：
当下游的服务因为某种原因响应过慢，下游服务主动停掉一些不太重要的业务，释放出服务器资源，增加响应速度！
当下游的服务因为某种原因不可用，上游主动调用本地的一些降级逻辑，避免卡顿，迅速返回给用户！
服务降级解决办法：
1. 简化执行流程
2. 关闭次要功能
3. 降低一致性
假设，你在业务上发现执行流程没法简化了，那只能降低一致性了，即将核心业务流程的同步改异步，将强一致性改最终一致性！

# CAP
CAP原则，指的是在一个分布式系统中，Consistency(一致性)、Availability(可用性)、Partition Tolerance(分区容错性)，不能同时成立。

强一致性就要有锁，有锁的话就会影响并发，进而影响可用性。

- 一致性：它要求在同一时刻点，分布式系统中的所有数据备份都处于同一状态。
- 可用性：在系统集群的一部分节点宕机后，系统依然能够响应用户的请求。
- 分区容错性：在网络区间通信出现失败，系统能够容忍。
一般来讲，基于网络的不稳定性，分布容错是不可避免的，所以我们默认CAP中的P总是成立的。

一致性的强制数据统一要求，必然会导致在更新数据时部分节点处于被锁定状态，此时不可对外提供服务，影响了服务的可用性，反之亦然。因此一致性和可用性不能同时满足。

我们接下来介绍的服务注册和发现组件中，Eureka满足了其中的AP，Consul和Zookeeper满足了其中的CP。

# 服务发现
1. 什么是服务发现？
服务发现组件记录了（大规模）分布式系统中所有服务的信息，人们或者其它服务可以据此找到这些服务。 DNS 就是一个简单的例子。当然，复杂系统的服务发现组件要提供更多的功能，例如，服务元数据存储、健康监控、多种查询和实时更新等。

不同的使用情境，服务发现的含义也不同。例如，网络设备发现、零配置网络（ rendezvous ）发现和 SOA 发现等。无论是哪一种使用情境，服务发现提供了一种协调机制，方便服务的发布和查找。

2. 服务发现应该具备哪些关键特性，理由是什么？
服务发现是支撑大规模 SOA （面向服务的体系结构 (Service-oriented architecture)）的核心服务，它必须是高可用的，提供注册、目录和查找三大关键特性，仅仅提供服务目录是不够的。

3. 你认为服务发现带来的主要好处是什么？
服务发现的主要好处是「零配置」：不用使用硬编码的网络地址，只需服务的名字（有时甚至连名字都不用）就能使用服务。

服务发现组件必须提供查询所有服务的部署状态和集中控制所有服务实例的手段。

1. 时至今日，哪一种服务发现解决方案是最可靠的？
目前，业界提供了很多种服务发现解决方案。

人们已经使用 DNS 很长时间了， DNS 可能是现有的最大的服务发现系统。小规模系统可以先使用 DNS 作为服务发现手段。一旦服务节点的启动和销毁变得更加动态， DNS 就有问题了，因为 DNS 记录传播的速度可能跟不上服务节点变化的速度。

ZooKeeper 大概是最成熟的配置存储方案，它的历史比较长，提供了包括配置管理、领导人选举和分布式锁在内的完整解决方案。因此， ZooKeeper 是非常有竞争力的通用的服务发现解决方案，当然，它也显得过于复杂。

etcd 和 doozerd 是新近出现的服务发现解决方案，它们与 ZooKeeper 具有相似的架构和功能，因此可与 ZooKeeper 互换使用。

Consul 是一种更新的服务发现解决方案。除了服务发现，它还提供了配置管理和一种键值存储。 Consul 提供了服务节点的健康检查功能，支持使用 DNS SRV 查找服务，这大大增强了它与其它系统的互操作性。 Consul 与 ZooKeeper 的主要区别是： Consul 提供了 DNS 和 HTTP 两种 API ，而 ZooKeeper 只支持专门客户端的访问。

如果你希望实现一个 AP( Availability and Partition ) 系统， Eureka 是一个很好的选择，并在 Netflix 得到了实战的检验。在出现网络分区时， Eureka 选择可用性，而不是一致性。

1. 在一个全新的系统中实现服务发现（相对）容易。已有的系统如何集成服务发现功能？
第一步，让服务的客户无需了解服务的具体部署细节，通过查询外部的服务信息存储来找到服务。一开始简单地使用属性保存服务的元数据就可以了，随着系统变得更加动态，再升级到使用外部的服务发现系统。

一旦选定了服务发现的机制（网络或者服务），理解了系统的优化点（这是最难的部分），接下来只要集成注册和查找组件就可以了。

# 分布式唯一ID的几种生成方案

全局唯一：必须保证ID是全局性唯一的，基本要求
高性能：高可用低延时，ID生成响应要块，否则反倒会成为业务瓶颈
高可用：100%的可用性是骗人的，但是也要无限接近于100%的可用性
好接入：要秉着拿来即用的设计原则，在系统设计和实现上要尽可能的简单
趋势递增：最好趋势递增，这个要求就得看具体业务场景了，一般不严格要求

UUID
数据库自增ID
数据库多主模式
号段模式
Redis
雪花算法（SnowFlake）
美团（Leaf）：实际就是号段模式，雪花算法的组合



